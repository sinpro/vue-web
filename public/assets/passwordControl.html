<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密码控件</title>
    <script language="javascript" src="./js/jquery-1.12.3.min.js"></script>
    <script language="javascript" src="./js/crypto-js.js"></script>
    <script language="javascript" src="./js/PassGuardCtrl.js"></script>
    <script>
        // 获取url传值
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg); //获取url中"?"符后的字符串并正则匹配
            var context = "";
            if(r != null)
                context = r[2];
            reg = null;
            r = null;
            return context == null || context == "" || context == "undefined" ? "" : context;
        };
        // var pgeRZRandNum='v0gid5atffi8dgq2ouplwzcs7v8s7kn0',
        //     pgeRZDataB='PaS7f/WecSXPJkJ5d6kB9UJuxq8El8DZa2aBXJvD2w4=',
        //     randomFactor="suijiyinzi"+new Date().getTime()+223;
        var pgeRZRandNum=GetQueryString('pgeRZRandNum'),
            pgeRZDataB=GetQueryString('pgeRZDataB'),
            randomFactor=GetQueryString('randomFactor'),
            isNeedLevel=GetQueryString('isNeedLevel');
            console.log(pgeRZRandNum,pgeRZDataB,randomFactor,isNeedLevel,1111)
        var pgeditor = new $.pge( {
            pgePath : "./controlInstall/",//控件文件目录
            pgeId : "_ocx_password",//控件ID
            pgeEdittype : 0,//控件类型,0星号,1明文
            pgeEreg1 : "[\\s\\S]*",//输入过程中字符类型限制
            pgeEreg2 : "[\\s\\S]{6,12}", //输入完毕后字符类型判断条件
            pgeMaxlength : 12,//允许最大输入长度
            pgeTabindex : 2,//tab键顺序
            pgeClass : "ocx_style",//控件css样式
            pgeInstallClass : "ocx_style",//针对安装或升级
            pgeOnkeydown : "FormSubmit()",//回车键响应函数
            tabCallback : "input2",//非IE tab键焦点切换的ID
            AffineX:"E81B4E4FECE753A48AB8E5A1396A391C909A0F9127418A5D41A2150FB1D885A4",
                AffineY:"1A65213A5379BEC31E63E9116D7789CB3C21020DAFF311FF47101FC573E3CB87",
            //windows10 edge&Chrome42+相关
            pgeOnfocus:"pgeFocus()",//监控光标切入密码控件框
            pgeOnblur:"pgeBlur()",//监控光标切出密码控件框
            pgeWindowID:"password"+new Date().getTime()+1,
            pgeRZRandNum:pgeRZRandNum,
            pgeRZDataB:pgeRZDataB
            // pgeRZRandNum:"v0gid5atffi8dgq2ouplwzcs7v8s7kn0",
            // pgeRZDataB:"PaS7f/WecSXPJkJ5d6kB9UJuxq8El8DZa2aBXJvD2w4="
        });
        window.pgeCtrl = pgeditor;
        pgeditor.pgInitialize();//初始化控件
        // 接受VUE页面发来的信息
        window.addEventListener("message", function(event){
            var data = event.data;
            if(data.isSubmit){
                this.FormSubmit()
            }
        });
        // 向父vue页面发送信息
        function sendDataVue(obj){
            window.parent.postMessage({
                params: obj
            }, '*');
        }
        var i = 0;
        //密码控件获得焦点时，提示一下
        function pgeFocus(){
            $("#tishi").html("获得焦点"+(i++));
            
            if(isNeedLevel==='true'){
               passwd_level()
            }
        }
        //密码控件失去焦点时获得密码强度，并展示出来
        function pgeBlur(){
            $("#tishi").html("失去焦点"+(i++));
            //显示密码强度
            if(isNeedLevel==='true'){
               GetLevel();
            }
        }
        // 是否需要密码等级控件
        function passwd_level(){
            if(isNeedLevel==='true'){
                _$("passwd_level").style.display = "block";
            }else{
                 _$("passwd_level").style.display = "none";
            }
        }
         //清除密码强度
        function ClearLevel() {
            _$("passwd_level_1").style.background = "url(./images/bg.gif)";
            _$("passwd_level_2").style.background = "url(./images/bg.gif)";
            _$("passwd_level_3").style.background = "url(./images/bg.gif)";
        }
        //判断密码强度
        function SetPWDStrength(n) {
            _$("passwd_level_1").style.background = "url(./images/bg.gif)";
            _$("passwd_level_2").style.background = "url(./images/bg.gif)";
            _$("passwd_level_3").style.background = "url(./images/bg.gif)";
            if (n == 1) {
                _$("passwd_level_1").style.background = "url(./images/bg1.gif)";
            }
            if (n == 2) {
                _$("passwd_level_1").style.background = "url(./images/bg1.gif)";
                _$("passwd_level_2").style.background = "url(./images/bg1.gif)";
            }
            if (n == 3) {
                _$("passwd_level_1").style.background = "url(./images/bg1.gif)";
                _$("passwd_level_2").style.background = "url(./images/bg1.gif)";
                _$("passwd_level_3").style.background = "url(./images/bg1.gif)";
            }
        }
        //获取密码强度
        function GetLevel() {
            var n = pgeditor.pwdStrength();
            console.log("n=================>", n)
            if (n > 0) {
                SetPWDStrength(n);
            } else {
                ClearLevel();
            }
        }
        //通过id获得页面元素
        function _$(v) {
            return document.getElementById(v);
        }
        //登录页面提交表单的方法
        function FormSubmit() {
            var length = pgeditor.pwdLength();//获得密码长度
            if (length == 0 || length == undefined) {
                setTimeout(function(){
                    alert("密码不能为空");
                    _$("_ocx_password").focus();
                },0);
                return false;
            }
            if (pgeditor.pwdValid() == 1) {//判断密码是否匹配正则表达式二
                setTimeout(function(){
                    alert("密码不符合要求");
                    _$("_ocx_password").focus();
                },0);
                return false;
            }
            pgeditor.pwdSetSk(randomFactor)
            // var pass=_$("username").value;
            var pwdResult = pgeditor.pwdSm2Result();//获取密码国密密文
            //var pwdResult = pgeditor.pwdSm2(pass);//获取密码国密密文，pass为待加密明文
            var machineNetwork = pgeditor.machineNetwork();//获取网卡信息密文
            var machineDisk = pgeditor.machineDisk();//获取硬盘信息密文
            var machineCPU = pgeditor.machineCPU();//获取CPU信息密文
            var obj={
                pwdResult:pwdResult,
                machineNetwork:machineNetwork,
                machineDisk:machineDisk,
                machineCPU:machineCPU,
            }
            this.sendDataVue(obj)
            // console.log(pass,pwdResult,machineNetwork,machineDisk,machineCPU,111)
        }
    </script>
    <style>
        *{margin: 0;padding: 0;}
        .ocx_style{
            width: 300px;
            border:1px solid #D9D9D9;
            height: 40px;
            line-height: 36px!important;
            padding: 0 16px;
            color: #1B1B1B;
            display: inline-block;
            padding: 0 16px;
        }
    </style>
</head>
<body>
    <div>
        <div>
            <script>
                pgeditor.generate();
            </script>
        </div>
        <div id="passwd_level">
            <table border="0" cellpadding="0" cellspacing="1"
                bgcolor="#D0D0D0">
                <tr>
                    <td width="48" height="6" align="center"
                        background="./images/bg.gif" id="passwd_level_1"></td>
                    <td width="48" height="6" align="center"
                        background="./images/bg.gif" id="passwd_level_2"></td>
                    <td width="48" height="6" align="center"
                        background="./images/bg.gif" id="passwd_level_3"></td>
                </tr>
            </table>
            <table border="0" cellpadding="0" cellspacing="1">
                <tr>
                    <td width="48" height="18" align="center" class="STYLE3">
                        弱
                    </td>
                    <td width="48" height="18" align="center" class="STYLE3">
                        中
                    </td>
                    <td width="48" height="18" align="center" class="STYLE3">
                        强
                    </td>
                </tr>
            </table>
        </div>
    </div>
    
</body>
</html>